<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/workingspace.css">
    <link rel="stylesheet" href="./css/workingshop.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./font/bootstrap-icons-1.10.0/bootstrap-icons.css">

    <script src="./js/jQuery.js"></script>
</head>

<body style="background-color: #FFFFFF;">

    <div class="container-fluid top_bar">
        <div class="container p-2">
            <div class="nav_bar">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="./workingspace.html">店铺主页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">商品管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">员工管理</a>
                    </li>
                    <li style="width: 60%;"></li>
                    <li class="d-flex user_a" style="cursor: pointer;">
                        <div class="p-2">
                            <img src="./images/avater.png" alt="" width="30px" height="30px" class="img align-middle">
                        </div>
                        <div class="userArea">
                            <div class="userName">jerk的店铺</div>
                            <div class="userWraper text-body-tertiary">jerk</div>
                        </div>
                        <i class="bi bi-chevron-down" style="line-height: 40px;font-size: 5px;"></i>
                        <div class="drop shadow-sm border border-light-subtle" style="padding:12px 18px 0;">
                            <div class="p-2" style="height: 50px;"><i class="bi bi-person-circle"></i><span
                                    class="align-middle"><a href="./working_user.html" style="text-decoration: none;"
                                        class="text-body-tertiary">账户信息</a></span></div>
                            <div class="p-2" style="height: 50px;"><i class="bi bi-shop-window"></i><span
                                    class="align-middle"><a href="./woring_store.html" style="text-decoration: none;"
                                        class="text-body-tertiary">店铺信息</a></span></div>
                            <div class="hr"></div>
                            <div class="p-2" style="height: 50px;"><span class="align-middle">退出当前账号</span></div>
                        </div>
                    </li>
                    <script>
                        $(function () {
                            $('.user_a').hover(function () {
                                $('.drop').css('display', 'block')
                            })
                            $('.user_a').mouseleave(function () {
                                $('.drop').css('display', 'none')
                            })
                        })
                    </script>
                </ul>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="container pt-4">
            <div class="">
                <div class="card border border-0 position-relative mb-5" style="width: 100%;background-color: #F4F7FF;">
                    <i class="bi bi-exclamation-circle-fill f_info text-primary fs-5"></i>
                    <div class="card-body text-secondary p-4 ps-5">
                        <p class="card-text">1.请及时管理自己的店铺</p>
                        <p class="card-text">2.请确保自己的销售情况是否符合情况</p>
                        <p class="card-text">3.请清点自己的货物是否正确</p>
                        <p class="card-text">4.请确保自己的货物的状态</p>
                    </div>
                </div>

                <nav class="nav border-bottom border-2 mb-5" id="nav_shop" style="height: 48px;">
                    <a class="nav-link active" aria-current="page" href="#" data-action="allproduct">全部的商品</a>
                    <a class="nav-link" href="#" data-action="productOfsale">出售中的商品 </a>
                    <a class="nav-link" href="#" data-action="productInwarehouse">仓库中的商品</a>
                </nav>

                <script>
                    // 给导航栏中的所有链接添加 click 事件监听器
                    $("#nav_shop a").click(function (event) {
                        // 阻止默认的链接跳转行为
                        event.preventDefault();

                        // 移除之前的激活状态
                        $("#nav_shop a.active").removeClass("active");

                        // 将当前点击的链接设置为激活状态
                        $(this).addClass("active");
                    });
                </script>

                <div class="d-flex flex-wrap justify-content-between">
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">商品id</span>
                        <input type="text" name="items_id" id="items_id" class="border border-0 bg-input"
                            autocomplete="off">
                    </div>
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">商品标题</span>
                        <input type="text" name="items_title" id="items_title" class="border border-0 bg-input"
                            autocomplete="off">
                    </div>
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">商家id</span>
                        <input type="text" name="merchant_id" id="merchant_id" class="border border-0 bg-input"
                            autocomplete="off">
                    </div>
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">价格</span>
                        <input type="number" name="price_low" id="price_low" class="border border-0 bg-input"
                            autocomplete="off" style="width: 100px;">
                        <span>至</span>
                        <input type="number" name="price_high" id="price_high" class="border border-0 bg-input"
                            autocomplete="off" style="width: 100px;">
                    </div>
                </div>
                <div class="d-flex flex-wrap justify-content-between">
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">一级类目</span>
                        <!-- <input type="text" name="items_id" id="items_id" class="border border-0 bg-input"
                            autocomplete="off"> -->
                        <select class="form-select category" id="bg-select">
                            <option selected value="">选择类目</option>
                            <option value="1">食品</option>
                            <option value="2">服装</option>
                            <option value="3">日用品</option>
                            <option value="4">家电</option>
                            <option value="5">饰品</option>
                        </select>
                    </div>
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">商品类型</span>
                        <!-- <input type="text" name="items_id" id="items_id" class="border border-0 bg-input"
                            autocomplete="off"> -->
                        <select class="form-select good_type" id="bg-select" style="width: 180px;">
                            <option selected value="">选择类型</option>
                            <option value="日需品">日需品</option>
                            <option value="奢侈品">奢侈品</option>
                            <option value="化妆品">化妆品</option>
                        </select>
                    </div>
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">折扣</span>
                        <!-- <input type="text" name="items_id" id="items_id" class="border border-0 bg-input"
                            autocomplete="off"> -->
                        <select class="form-select discontinued" id="bg-select" style="width: 190px;">
                            <option selected value="">选择折扣</option>
                            <option value="1">有折扣</option>
                            <option value="0">无折扣</option>
                        </select>
                    </div>
                    <div class="input_id p-2 me-4 ps-3">
                        <span class="id_label text-body-tertiary">销量</span>
                        <input type="number" name="sale_low" id="sale_low" class="border border-0 bg-input"
                            autocomplete="off" style="width: 100px;">
                        <span>至</span>
                        <input type="number" name="sale_high" id="sale_high" class="border border-0 bg-input"
                            autocomplete="off" style="width: 100px;">
                    </div>
                </div>
                <div class="d-flex flex-wrap">
                    <div class="input_id p-2 me-5 ps-3">
                        <span class="id_label text-body-tertiary">状态</span>
                        <!-- <input type="text" name="items_id" id="items_id" class="border border-0 bg-input"
                            autocomplete="off"> -->
                        <select class="form-select status" id="bg-select" style="width: 190px;">
                            <option selected value="">选择状态</option>
                            <option value="1">上架中</option>
                            <option value="0">未上架</option>
                            <option value="2">售罄</option>
                        </select>
                    </div>
                    <div class="input_id p-2 me-5 ps-3">
                        <span class="id_label text-body-tertiary">是否过期</span>
                        <!-- <input type="text" name="items_id" id="items_id" class="border border-0 bg-input"
                            autocomplete="off"> -->
                        <select class="form-select is_expire" id="bg-select" style="width: 175px;">
                            <option selected value="">选择日期</option>
                            <option value="1">过期</option>
                            <option value="0">未过期</option>
                        </select>
                    </div>
                    <div class="pt-2 me-3" style="height: 70px;"><button type="button" class="btn btn-outline-success"
                            id="search">搜索</button></div>
                    <div class="text-body-tertiary pt-3"><i class="bi bi-cloud"></i><a href="javascript:;"
                            class="cleared_condition text-body-tertiary">清除条件</a></div>
                </div>

                <div class="row mb-4">
                    <div class="col-2"><button type="button" class="btn btn-primary" id="addp">添加商品</button></div>
                    <div class="col-1 pt-2"><span>已选</span></div>
                    <div class="col-2"><button type="button" class="btn btn-outline-secondary"
                            id="delChecked">批量删除</button></div>
                    <div class="col-2"><button type="button" class="btn btn-outline-secondary"
                            id="undercarriage">批量下架</button></div>
                    <div class="col-2">
                        <select class="form-select More_Actions">
                            <option selected value="">更多批量操作</option>
                            <option value="1" id="Shelves">批量上架</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                        </select>

                    </div>
                    <div class="col-2"><button type="button" class="btn btn-outline-primary"
                            id="Confirm_operation">确定操作</button></div>
                    <div class="col-1 pt-2">共选<span class="number_sel">0</span>件商品</div>
                </div>

                <table class="table" id="productTable">
                    <thead id="goods_head">
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                                </div>
                            </th>
                            <th>商品名称</th>
                            <th>价格</th>
                            <th>库存</th>
                            <th>销量</th>
                            <th>创建时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" class="text-center align-middle text-body-tertiary" style="height: 100px;">
                                没有数据
                            </td>
                        </tr>
                    </tbody>
                    <!-- Modal -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">商品信息</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">

                                </div>
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary confirmBtn">确定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </table>
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <script src="./js/jQuery.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/jquery.twbsPagination.min.js"></script>
    <script>
        // 定义每页显示的条目数和当前页码
        var currentPage = 1;
        var $table = $('#productTable');
        var $pagination = $('#pagination');
        var $tableBody = $('#tableBody');
        var search_data = {}

        function loadTable(res, types) {
            $tableBody.empty()
            $.each(res.list, function (index, product) {
                // 为每一条数据创建一个表格行
                var $row = $('<tr>');
                $row.append(
                    '<td><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="flexCheckDefault"></div></td>'
                )
                $row.append($('<td>').text(product.productName));
                $row.append($('<td>').text(product.price));
                $row.append($('<td>').text(product.stock));
                $row.append($('<td>').text(product.saleVolume));
                $row.append($('<td>').text(product.createTime));
                if (product.status === 1) {
                    $row.append($('<td>').append('<span class="badge text-bg-success">销售中</span>'));
                } else if (product.status === 0) {
                    $row.append($('<td>').append('<span class="badge text-bg-warning">仓库中</span>'));
                } else {
                    $row.append($('<td>').append('<span class="badge text-bg-danger">售罄</span>'));
                }

                // $row.append($('<td>').text(product.groundingTime));
                // 创建编辑按钮
                var $editBtn = $('<button>').attr({
                        'type': 'button',
                        "data-action": "edit", // 将 data-action 属性设置为 'edit'，以便更新操作时识别
                        "data-product-id": product.productID // 保存商户 ID，用于更新操作
                    })
                    .addClass('btn btn-light')
                    .attr('data-bs-toggle', 'modal')
                    .attr('data-bs-target', '#exampleModal')
                    .text('编辑');
                $editBtn.on('click', function () {
                    // 点击按钮时执行的操作
                });
                // 创建删除按钮
                var $deleteBtn = $('<button>').attr({
                        'type': 'button',
                        "data-id": product.productID,
                    })
                    .addClass('btn btn-danger')
                    .text('删除');
                $deleteBtn.on('click', function () {
                    // 点击按钮时执行的操作
                    var id = $(this).attr("data-id");
                    console.log(id)
                    $.ajax({
                        type: "DELETE",
                        url: "http://127.0.0.1:8080/delproduct/" + id,
                        success: function (data) {
                            // 删除成功后的处理
                            // 重新加载数据
                            loadData(currentPage);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error(textStatus);
                        }
                    });
                });
                // 将按钮添加到操作列
                $row.append($('<td>').append($editBtn).append($deleteBtn));
                // 将该表格行添加到表格中
                $table.find('tbody').append($row);
            });

            if (types === "search") {
                $pagination.twbsPagination({
                    totalPages: res.pages, // 总页数
                    visiblePages: res.navigatePages, // 显示的页码数
                    onPageClick: function (event, page) {
                        // 点击页码时执行的操作
                        currentPage = page;
                        loadSearch(currentPage, search_data)
                    }
                });
            } else if (types === "alldata") {
                $pagination.twbsPagination({
                    totalPages: res.pages, // 总页数
                    visiblePages: res.navigatePages, // 显示的页码数
                    onPageClick: function (event, page) {
                        // 点击页码时执行的操作
                        currentPage = page;
                        loadData(currentPage)
                    }
                });
            } else if (types === 1) {
                $pagination.twbsPagination({
                    totalPages: res.pages, // 总页数
                    visiblePages: res.navigatePages, // 显示的页码数
                    onPageClick: function (event, page) {
                        // 点击页码时执行的操作
                        currentPage = page;
                        loadproductByStatus(currentPage, 1)
                    }
                });
            } else if (types === 0) {
                $pagination.twbsPagination({
                    totalPages: res.pages, // 总页数
                    visiblePages: res.navigatePages, // 显示的页码数
                    onPageClick: function (event, page) {
                        // 点击页码时执行的操作
                        currentPage = page;
                        loadproductByStatus(currentPage, 0)
                    }
                });
            }
        }

        function loadData(pageNo) {
            $.ajax({
                type: "GET", // 请求方式，可以选择"GET"或"POST"
                url: "http://127.0.0.1:8080/products/" + parseInt(pageNo), // 服务器端接收请求的地址
                contentType: "application/json; charset=utf-8", // 设置请求头信息
                success: function (res) { // 成功回调函数
                    loadTable(res, "alldata");
                },
                error: function (xhr, status, error) { // 失败回调函数
                    alert(error);
                }
            })
        }
        loadData(currentPage)

        // 给thead中的checkbox绑定点击事件
        $("#goods_head input[type='checkbox']").on("click", function () {
            // 获取thead中的checkbox的选中状态
            var isChecked = $(this).is(':checked');
            // 将tbody中的所有checkbox设为相同的选中状态
            $("#tableBody input[type='checkbox']").prop('checked', isChecked);
        });

        // 给tbody中的checkbox绑定点击事件
        $("#tableBody").on("click", "input[type='checkbox']", function () {
            // 获取tbody中所有checkbox的个数
            var allLength = $("#tableBody input[type='checkbox']").length;
            // 获取已选中的checkbox的个数
            var checkedLength = $("#tableBody input[type='checkbox']:checked").length;
            // 判断tbody中的checkbox是否全部选中
            var allChecked = allLength == checkedLength;
            // 将thead中的checkbox设为相同的选中状态
            $("#goods_head input[type='checkbox']").prop('checked', allChecked);
        });

        // 给批量删除按钮绑定点击事件
        $("#delChecked").on("click", function () {
            var ids = []; // 定义一个空数组用于存储选中行的id
            $('#productTable tbody tr').each(function () {
                if ($(this).find('input[type="checkbox"]').prop('checked')) { // 判断该行是否选中
                    ids.push($(this).find('button[data-id]').attr('data-id')); // 将该行的id添加到ids数组中
                }
            });

            console.log(ids); // 打印选中行的id数据

            if (ids.length === 0) {
                alert("未选中数据")
            } else {
                $.ajax({
                    type: "POST",
                    url: "http://127.0.0.1:8080/deleteGoods",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(ids),
                    success: function (result) {
                        console.log(result);
                        loadData(currentPage)
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }
        });

        $('.cleared_condition').click(function () {
            $('input[type="text"]').val('');
            $('input[type="number"]').val('');
            $('select').prop('selectedIndex', 0);
        });

        $("#search").click(function () {
            var items_id = $('#items_id').val();
            var items_title = $('#items_title').val();
            var merchant_id = $('#merchant_id').val();
            var price_low = $('#price_low').val();
            var price_high = $('#price_high').val();
            var sale_low = $('#sale_low').val();
            var sale_high = $('#sale_high').val();
            var category = $('.category option:selected').val();
            var good_type = $('.good_type option:selected').val();
            var discontinued = $('.discontinued option:selected').val();
            var status = $('.status option:selected').val();
            var is_expire = $('.is_expire option:selected').val();

            search_data = {
                items_id: items_id,
                items_title: items_title,
                merchant_id: merchant_id,
                price_low: price_low,
                price_high: price_high,
                sale_low: sale_low,
                sale_high: sale_high,
                category: category,
                good_type: good_type,
                discontinued: discontinued,
                status: status,
                is_expire: is_expire
            }
            $pagination.twbsPagination('destroy');
            loadSearch(currentPage, search_data);
        });

        function loadSearch(currentPage, search_data) {
            // 发送Ajax请求
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:8080/searchGoods/" + currentPage,
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(search_data),
                success: function (data) {
                    console.log(data)
                    loadTable(data, "search")
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        // 为复选框添加 change 事件处理程序
        $('#productTable').on('change', 'input[type="checkbox"]', function () {
            // 获取所有被选中的复选框
            const $selectedCheckboxes = $('#tableBody input[type="checkbox"]:checked');

            // 更新显示数量的 span 标签
            $('.number_sel').text($selectedCheckboxes.length);
        });

        // 给批量下架按钮绑定点击事件
        $("#undercarriage").on("click", function () {
            var ids = []; // 定义一个空数组用于存储选中行的id
            $('#productTable tbody tr').each(function () {
                if ($(this).find('input[type="checkbox"]').prop('checked')) { // 判断该行是否选中
                    ids.push($(this).find('button[data-id]').attr('data-id')); // 将该行的id添加到ids数组中
                }
            });

            console.log(ids); // 打印选中行的id数据

            if (ids.length === 0) {
                alert("未选中数据")
            } else {
                $.ajax({
                    type: "POST",
                    url: "http://127.0.0.1:8080/offSlef",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(ids),
                    success: function (result) {
                        console.log(result);
                        loadData(currentPage)
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }
        });

        // 给确定操作按钮绑定点击事件
        $("#Confirm_operation").on("click", function () {
            var ids = []; // 定义一个空数组用于存储选中行的id
            $('#productTable tbody tr').each(function () {
                if ($(this).find('input[type="checkbox"]').prop('checked')) { // 判断该行是否选中
                    ids.push($(this).find('button[data-id]').attr('data-id')); // 将该行的id添加到ids数组中
                }
            });

            console.log(ids); // 打印选中行的id数据
            var More_Actions = $('.More_Actions option:selected').val();
            console.log(More_Actions)
            if (ids.length === 0) {
                alert("未选中数据")
            } else {
                if (More_Actions === "1") {
                    Shelves(ids)
                } else {
                    console.log("其他操作")
                }
            }
        });

        function Shelves(ids) {
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:8080/Shelves",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(ids),
                success: function (result) {
                    console.log(result);
                    loadData(currentPage)
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }
        $('#nav_shop a').click(function () {
            var action = $(this).attr("data-action");
            if (action === "allproduct") {
                $pagination.twbsPagination('destroy');
                loadData(currentPage);
            } else if (action === "productOfsale") {
                $pagination.twbsPagination('destroy');
                loadproductByStatus(currentPage, 1);
            } else if (action === "productInwarehouse") {
                $pagination.twbsPagination('destroy');
                loadproductByStatus(currentPage, 0);
            } else {

            }
        });

        function loadproductByStatus(currentPage, status) {
            // 发送Ajax请求
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:8080/loadproductByStatus/" + currentPage + "?status=" + status,
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log(data)
                    loadTable(data, status)
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
        $('#addp').click(function () {
            window.location.href = './working_addProduct.html'
        });
    </script>

</body>

</html>